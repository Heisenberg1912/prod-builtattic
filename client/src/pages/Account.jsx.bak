import React, { useEffect, useMemo, useState } from "react";
import { Link } from "react-router-dom";
import {
  CalendarRange,
  Crown,
  Gift,
  Headphones,
  Heart,
  MapPin,
  MessageSquare,
  PackageCheck,
  Repeat,
  Settings2,
  ShieldCheck,
  ShoppingBag,
  Sparkles,
  Star,
  Ticket,
  TrendingUp,
  UserCog,
  Wallet,
} from "lucide-react";

import { fetchOrders } from "../services/orders.js";
import { useCart } from "../context/CartContext";

const CARD_BASE = "rounded-3xl border border-white/10 bg-white/5 backdrop-blur transition shadow-lg hover:shadow-xl hover:border-white/20";
const CTA_BUTTON = "inline-flex items-center justify-center rounded-full border border-white/20 px-4 py-1.5 text-xs font-semibold text-white/90 hover:bg-white/10 transition";

const quickAccessTiles = [
  {
    title: "Your Orders",
    description: "Check status and history.",
    icon: ShoppingBag,
    to: "/orders",
  },
  {
    title: "Buy it Again",
    description: "Repeat past purchases fast.",
    icon: Repeat,
    to: "/orders",
  },
  {
    title: "Wishlist",
    description: "Save ideas for later.",
    icon: Heart,
    to: "/wishlist",
  },
  {
    title: "Prime Concierge",
    description: "Ping the support desk.",
    icon: Headphones,
    to: "/support",
  },
];

const accountTiles = [
  {
    title: "Login & Security",
    description: "Password, MFA, devices.",
    icon: ShieldCheck,
    to: "/settings",
    cta: "Manage",
  },
  {
    title: "Delivery Addresses",
    description: "Keep site details current.",
    icon: MapPin,
    to: "/settings",
    cta: "Edit",
  },
  {
    title: "Payment Options",
    description: "Cards, UPI, escrow rules.",
    icon: Wallet,
    to: "/cart",
    cta: "Review",
  },
  {
    title: "Gift Cards & Credits",
    description: "Apply codes in one place.",
    icon: Gift,
    to: "/account",
    cta: "Redeem",
  },
  {
    title: "Communication Settings",
    description: "Pick the updates you want.",
    icon: MessageSquare,
    to: "/settings",
    cta: "Update",
  },
  {
    title: "Invite Collaborators",
    description: "Add clients and partners.",
    icon: UserCog,
    to: "/associates",
    cta: "Invite",
  },
];

const supportTiles = [
  {
    title: "Priority Studio Support",
    description: "Concierge help on demand.",
    icon: Crown,
    to: null,
    cta: "Contact",
  },
  {
    title: "Account Preferences",
    description: "Tune privacy and region quickly.",
    icon: Settings2,
    to: "/settings",
    cta: "Adjust",
  },
  {
    title: "Professional Services",
    description: "Browse vetted experts fast.",
    icon: PackageCheck,
    to: "/associates",
    cta: "Explore",
  },
  {
    title: "Coupons & Events",
    description: "Unlock launch deals across studios and materials.",
    icon: Ticket,
    to: "/studio",
    cta: "View",
  },
];

const readProfileSnapshot = () => {
  if (typeof window === "undefined") return null;
  try {
    return JSON.parse(localStorage.getItem("builtattic_profile"));
  } catch {
    return null;
  }
};

const readWishlistCount = () => {
  if (typeof window === "undefined") return 0;
  try {
    const raw = localStorage.getItem("wishlist");
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed.length : 0;
  } catch {
    return 0;
  }
};

const formatCurrency = (value, currency = "INR") => {
  if (!Number.isFinite(value)) return "-";
  return new Intl.NumberFormat(undefined, {
    style: "currency",
    currency,
    maximumFractionDigits: 0,
  }).format(value);
};

const initialsFrom = (nameOrEmail) => {
  if (!nameOrEmail) return "BT";
  const source = nameOrEmail.trim();
  if (!source) return "BT";
  const namePart = source.includes("@") ? source.split("@")[0] : source;
  const tokens = namePart.split(/[\s._-]+/).filter(Boolean);
  if (!tokens.length) return source.slice(0, 2).toUpperCase();
  const first = tokens[0][0] || "";
  const last = tokens.length > 1 ? tokens[tokens.length - 1][0] : tokens[0][1] || "";
  return `${first}${last}`.toUpperCase();
};

const Account = () => {
  const { cartItems } = useCart();
  const [profile, setProfile] = useState(() => readProfileSnapshot() || {});
  const [orders, setOrders] = useState([]);
  const [loadingOrders, setLoadingOrders] = useState(false);
  const [ordersError, setOrdersError] = useState(null);
  const [wishlistCount, setWishlistCount] = useState(() => readWishlistCount());

  useEffect(() => {
    const handleStorage = (event) => {
      if (event.key === "builtattic_profile") {
        setProfile(readProfileSnapshot() || {});
      }
      if (event.key === "wishlist") {
        setWishlistCount(readWishlistCount());
      }
    };
    window.addEventListener("storage", handleStorage);
    return () => window.removeEventListener("storage", handleStorage);
  }, []);

  useEffect(() => {
    let active = true;
    const loadOrders = async () => {
      setLoadingOrders(true);
      setOrdersError(null);
      try {
        const remote = await fetchOrders();
        if (!active) return;
        if (Array.isArray(remote) && remote.length) {
          setOrders(remote);
        }
      } catch (error) {
        if (!active) return;
        setOrdersError(error?.message || "Unable to sync your orders right now.");
      } finally {
        if (active) setLoadingOrders(false);
      }
    };
    loadOrders();
    return () => {
      active = false;
    };
  }, []);

  const orderStats = useMemo(() => {
    if (!orders.length) return { total: 0, spend: 0 }; 
    const spend = orders.reduce((sum, order) => {
      const grand = Number(order?.amounts?.grand ?? order?.amounts?.subtotal ?? 0);
      return sum + (Number.isFinite(grand) ? grand : 0);
    }, 0);
    return {
      total: orders.length,
      spend,
    };
  }, [orders]);

  const recentOrders = useMemo(() => {
    if (!orders.length) return [];
    return orders
      .slice(0, 3)
      .map((order) => {
        const createdAt = order?.createdAt ? new Date(order.createdAt) : null;
        const item = order?.items?.[0] || {};
        const currency = item?.currency || order?.amounts?.currency || "INR";
        const total = Number(order?.amounts?.grand ?? order?.amounts?.subtotal ?? 0);
        return {
          id: order?._id || order?.id || crypto.randomUUID?.() || Math.random().toString(36).slice(2, 8),
          title: item?.title || item?.name || "Marketplace order",
          status: (order?.status || "created").replace(/_/g, " "),
          amount: formatCurrency(total, currency),
          placedOn: createdAt ? createdAt.toLocaleDateString() : "—",
        };
      });
  }, [orders]);

  const cartCount = Array.isArray(cartItems) ? cartItems.length : 0;
  const stats = [
    {
      label: "Orders placed",
      value: orderStats.total,
      icon: PackageCheck,
      subLabel: orderStats.total ? "Across studios, materials, and associates" : "No orders yet",
    },
    {
      label: "Lifetime spend",
      value: orderStats.spend ? formatCurrency(orderStats.spend) : "—",
      icon: TrendingUp,
      subLabel: "Reflects captured invoices and escrow releases",
    },
    {
      label: "Wishlist",
      value: wishlistCount,
      icon: Star,
      subLabel: wishlistCount ? "Saved for later" : "Add ideas to revisit",
    },
    {
      label: "Cart",
      value: cartCount,
      icon: CalendarRange,
      subLabel: cartCount ? "Ready for checkout" : "No items in cart",
    },
  ];

  const fullName = profile?.name || "Guest";
  const email = profile?.email || "guest@builtattic.com";
  const membership = profile?.membership || "Prime Access";
  const initials = initialsFrom(fullName || email);

  return (
    <div className="relative min-h-screen bg-slate-950 text-white">
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute -top-40 -left-32 h-96 w-96 rounded-full bg-violet-600/30 blur-[120px]" />
        <div className="absolute top-32 right-[-6rem] h-[28rem] w-[28rem] rounded-full bg-sky-500/20 blur-[140px]" />
        <div className="absolute bottom-10 left-1/2 -translate-x-1/2 h-72 w-[36rem] rounded-full bg-emerald-500/10 blur-[140px]" />
      </div>

      <main className="relative mx-auto flex max-w-6xl flex-col gap-12 px-6 pb-20 pt-16">
        <section className="grid gap-8 lg:grid-cols-[minmax(0,1fr)_minmax(0,320px)] items-start">
          <div className="rounded-3xl border border-white/10 bg-gradient-to-br from-white/10 via-white/5 to-white/10 p-8 shadow-2xl">
            <div className="flex flex-wrap items-start justify-between gap-6">
              <div className="flex items-center gap-5">
                <span className="flex h-16 w-16 items-center justify-center rounded-2xl bg-white/10 text-2xl font-semibold text-white shadow-inner shadow-white/20">
                  {initials}
                </span>
                <div className="space-y-1">
                  <p className="text-sm uppercase tracking-[0.35em] text-white/60">Account</p>
                  <h1 className="text-3xl font-semibold tracking-tight text-white">{fullName}</h1>
                  <p className="text-sm text-white/70">{email}</p>
                </div>
              </div>
              <div className="rounded-2xl border border-white/20 bg-white/10 px-5 py-3 text-sm text-white/80 shadow">
                <div className="flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-white/60">
                  <Sparkles size={14} /> Membership
                </div>
                <p className="mt-2 text-base font-semibold text-white">{membership}</p>
                <p className="text-xs text-white/70">Enjoy priority support.</p>
              </div>
            </div>

            <div className="mt-8 grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
              {stats.map((stat) => {
                const Icon = stat.icon;
                return (
                  <div
                    key={stat.label}
                    className="rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-white/10 hover:border-white/20"
                  >
                    <div className="flex items-center justify-between gap-2">
                      <p className="text-xs uppercase tracking-[0.3em] text-white/60">{stat.label}</p>
                      <span className="rounded-full bg-white/10 p-2 text-white">
                        <Icon size={16} />
                      </span>
                    </div>
                    <p className="mt-3 text-2xl font-semibold text-white">
                      {typeof stat.value === 'number' ? stat.value.toLocaleString() : stat.value}
                    </p>
                    <p className="text-xs text-white/65">{stat.subLabel}</p>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="rounded-3xl border border-emerald-200/40 bg-gradient-to-br from-emerald-500/20 via-emerald-300/20 to-emerald-500/10 p-6 shadow-lg">
            <div className="flex items-center gap-4">
              <span className="rounded-full bg-white/20 p-3 text-white">
                <Star size={20} />
              </span>
              <div>
                <p className="text-sm uppercase tracking-[0.3em] text-white/70">Refer & earn</p>
                <h2 className="text-xl font-semibold text-white">Bring your collaborators</h2>
                <p className="text-sm text-white/80">
                  Unlock ₹7,500 in credits for every studio or associate your network books through Builtattic.
                </p>
              </div>
            </div>
            <Link
              to="/associates"
              className="mt-6 inline-flex items-center gap-2 rounded-full bg-white/90 px-4 py-2 text-sm font-semibold text-slate-900 shadow hover:bg-white"
            >
              Invite from CRM
            </Link>
          </div>
        </section>

        <section className="space-y-4">
          <div className="flex flex-wrap items-center justify-between gap-3">
            <h2 className="text-lg font-semibold text-white">Quick access</h2>
            {loadingOrders && (
              <span className="text-xs text-white/60">Syncing latest activity…</span>
            )}
          </div>
          <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
            {quickAccessTiles.map((tile) => {
              const Icon = tile.icon;
              return (
                <Link
                  key={tile.title}
                  to={tile.to}
                  className={`${CARD_BASE} p-5 hover:-translate-y-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40`}
                >
                  <div className="flex items-center gap-3">
                    <span className="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white">
                      <Icon size={20} />
                    </span>
                    <div>
                      <h3 className="text-base font-semibold text-white">{tile.title}</h3>
                      <p className="text-sm text-white/70 leading-relaxed">{tile.description}</p>
                    </div>
                  </div>
                </Link>
              );
            })}
          </div>
        </section>

        <section className="space-y-4">
          <div className="flex flex-wrap items-center justify-between gap-3">
            <h2 className="text-lg font-semibold text-white">Recent activity</h2>
            <Link to="/orders" className="text-xs font-semibold text-white/80 hover:text-white">View all orders</Link>
          </div>
          <div className="grid gap-4 lg:grid-cols-3">
            {recentOrders.length ? (
              recentOrders.map((order) => (
                <div key={order.id} className={`${CARD_BASE} p-5`}
                >
                  <p className="text-xs uppercase tracking-[0.3em] text-white/60">{order.placedOn}</p>
                  <h3 className="mt-3 text-base font-semibold text-white line-clamp-2">{order.title}</h3>
                  <p className="text-sm text-white/70">Status: {order.status}</p>
                  <p className="mt-3 text-lg font-semibold text-white">{order.amount}</p>
                  <Link to="/orders" className="mt-4 inline-flex items-center text-xs font-semibold text-white/80 hover:text-white">
                    Track order →
                  </Link>
                </div>
              ))
            ) : (
              <div className={`${CARD_BASE} p-6 lg:col-span-3 text-center text-white/70`}>
                No orders yet. Explore the marketplace to get started.
              </div>
            )}
          </div>
          {ordersError && (
            <div className="rounded-2xl border border-amber-200/40 bg-amber-500/10 px-4 py-3 text-xs text-amber-200">
              {ordersError}
            </div>
          )}
        </section>

        <section className="space-y-4">
          <h2 className="text-lg font-semibold text-white">Account management</h2>
          <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
            {accountTiles.map((tile) => {
              const Icon = tile.icon;
              return (
                <div key={tile.title} className={`${CARD_BASE} p-5 flex flex-col gap-4`}>
                  <div className="flex items-center gap-3">
                    <span className="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white">
                      <Icon size={20} />
                    </span>
                    <div>
                      <h3 className="text-base font-semibold text-white">{tile.title}</h3>
                      <p className="text-sm text-white/70 leading-relaxed">{tile.description}</p>
                    </div>
                  </div>
                  {tile.cta && (
                    tile.to ? (
                      <Link to={tile.to} className={CTA_BUTTON}>
                        {tile.cta}
                      </Link>
                    ) : (
                      <button type="button" className={CTA_BUTTON}>
                        {tile.cta}
                      </button>
                    )
                  )}
                </div>
              );
            })}
          </div>
        </section>

        <section className="space-y-4 pb-10">
          <h2 className="text-lg font-semibold text-white">Support & concierge</h2>
          <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
            {supportTiles.map((tile) => {
              const Icon = tile.icon;
              return (
                <div key={tile.title} className={`${CARD_BASE} p-5 flex flex-col gap-3`}>
                  <div className="flex items-center gap-3">
                    <span className="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white">
                      <Icon size={20} />
                    </span>
                    <div>
                      <h3 className="text-base font-semibold text-white">{tile.title}</h3>
                      <p className="text-sm text-white/70 leading-relaxed">{tile.description}</p>
                    </div>
                  </div>
                  {tile.cta && (
                    tile.to ? (
                      <Link to={tile.to} className={CTA_BUTTON}>
                        {tile.cta}
                      </Link>
                    ) : (
                      <button type="button" className={CTA_BUTTON}>
                        {tile.cta}
                      </button>
                    )
                  )}
                </div>
              );
            })}
          </div>
        </section>
      </main>
    </div>
  );
};

export default Account;

